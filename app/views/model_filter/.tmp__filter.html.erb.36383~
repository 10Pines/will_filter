<script>
	function saveFilter() {
		filter_name = prompt("Please provide the name for the filter:");
		if (filter_name == null) {
			return;
		}

		$("loader_icon").show();
		$("filter_name").value = filter_name;		

		form_hash = $('filter_form').serialize(true);
		
		new Ajax.Updater('filter', '/data_filter/save_filter', {
		  parameters: form_hash,
			onComplete: function(transport) {
				$("loader_icon").hide();
				enableControlButtons();
			} 
		});
	}

	function toggleSQLConditions() {
		$("sql_conditions").toggle();
	}
	
	function changeFilterModel() {
		$("loader_icon").show();
		form_hash = $('filter_form').serialize(true);
		
		$("filter_dirty").show();
		
		form_hash["model_changed"] = true
		
		new Ajax.Updater('filter', '/data_filter/change_filter_model', {
		  parameters: form_hash,
			onComplete: function(transport) {
				$("loader_icon").hide();
				disableControlButtons();
				enableControlButtons();
			} 
		});
		
	}
	
	function updateFilter() {
		filter_name = prompt("Please provide the name for the filter:", $("filter_name").value);
		if (filter_name == null) {
			return;
		}

		$("loader_icon").show();
		$("filter_name").value = filter_name;		

		form_hash = $('filter_form').serialize(true);
		
		new Ajax.Updater('filter', '/data_filter/update_filter', {
		  parameters: form_hash,
			onComplete: function(transport) {
				$("loader_icon").hide();
			} 
		});
	}

	function deleteFilter() {
		if (!confirm("Are you sure you want to delete this filter?")) {
			return;
		}

		$("loader_icon").show();
		form_hash = $('filter_form').serialize(true);
		
		new Ajax.Updater('filter', '/data_filter/delete_filter', {
		  parameters: form_hash,
			onComplete: function(transport) {
				$("loader_icon").hide();
				$('filter_form').submit();
			} 
		});
		
	}
	
	function disableControlButtons() {
		$("filterDeleteBtn").disabled = true;
		$("filterUpdateBtn").disabled = true;
		$("filterSaveAsBtn").disabled = true;
	}

	function enableControlButtons() {
		disableControlButtons();
		
		if ($("filter_id").value != "") {
			$("filterDeleteBtn").disabled = false;
			$("filterUpdateBtn").disabled = false;
		}
		$("filterSaveAsBtn").disabled = false;
	}
	
	function markDirty() {
		if ($("selected_filter_key") && $("filter_id").value == "") {
			$("selected_filter_key").value = "-1";
		}

		disableControlButtons();
		$("filter_dirty").show();
	}
	
	function toggleFilter() {
		if ($("filter_container").style.display == "none") {
			$("filter_container").show();
			$("filter_toggler").innerHTML = "- Filter";
		} else {
			$("filter_container").hide();
			$("filter_toggler").innerHTML = "+ Filter";
		}
	}

	function loadPredefinedFilter() {
		if ($("selected_filter_key").value == "-1" || $("selected_filter_key").value == "-2")
			return

		$("loader_icon").show();
		form_hash = $('filter_form').serialize(true);

		new Ajax.Updater('filter', '/data_filter/load_filter', {
		  parameters: form_hash,
			onComplete: function(transport) {
				$("loader_icon").hide();
				$('filter_form').submit();
			} 
		});
  }
	
	function performFilterAction(action) {
//		form_vals = $('filter_form').serialize();
//		alert(form_vals);
		
		if (action=="submit") {
			$('filter_form').submit();
			return;			
		}

		$("loader_icon").show();

		markDirty();
		
		form_hash = $('filter_form').serialize(true);
		form_hash["filter_action"] = action;
		
		new Ajax.Updater('filter', '/data_filter/update', {
		  parameters: form_hash,
			evalScripts: true,
			onComplete: function(transport) {
				$("loader_icon").hide();
			} 
		});
		
	}
</script>

<% form_tag({:controller=>params["controller"], :action => params["action"]}, :method => :get, :name=>'filter_form', :id => 'filter_form') do %>
<input type="hidden" name="<%=DataFilter::HTML_FILTER_TYPE%>" value="<%=@filter.class.name%>">

<fieldset style="border: #ccc solid 1px;">
<legend style="font-weight:bold"> 
	<a id="filter_toggler" href="javascript:toggleFilter()">- Filter</a>
	<span id="filter_dirty" style="<%='display:none;' unless filter.errors? %> color:red; font-size:9px;">
	(modified and must be submitted)</span> 
</legend>
<div id="filter_container">

<div id="filter">
<%= render :partial=> "/data_filter/filter_criteria" %>
</div>

<table width="100%">
	<tr>
		<td align="left" style="padding:5px; width:10%">
			<input type="button" value="+" onClick="performFilterAction('addCriteriaLast')">
			<input type="button" value="- all" onClick="performFilterAction('clear')">
		</td>
		<td>
			<div id="loader_icon" style="display:none">
				<%=image_tag "/images/spinner.gif" %>
			</div>
		</td>
		<td align="right" style="padding:5px">
 		  <%=link_to_function("SQL Conditions", "toggleSQLConditions()", :style=>"font-size:9px")%>
			&nbsp;&nbsp;
			&nbsp;&nbsp;
			<input type="button" value="Delete" id="filterDeleteBtn" onClick="deleteFilter()">
			<input type="button" value="Update" id="filterUpdateBtn" onClick="updateFilter()">
			<input type="button" value="Save As.." id="filterSaveAsBtn" onClick="saveFilter()">
			&nbsp;&nbsp;
			<input type="button" value="Submit" onClick="performFilterAction('submit')">
			&nbsp;
		</td>
	</tr>
</table>

<table width="100%" id="sql_conditions" style="display:none; font-size:10px; border:1px solid black; width:100%">
	<tr><td style="padding:5px">
		<%= @filter.debug_sql_conditions %>
	</td></tr>
</table>		

</div>
</fieldset>
<% end %>

<script>
	disableControlButtons();
	<% if not @filter.errors? %>
		enableControlButtons();
	<% end %>
</script>

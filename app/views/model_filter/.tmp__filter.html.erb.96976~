<script>
  <!--

  function beginLoading() {
		$("mf_loader").show();
  }
  
  function finishLoading() {
		$("mf_loader").hide();
  }
	
	function toggleSQLConditions() {
		$("mf_sql_conditions").toggle();
	}
	
	function disableControlButtons() {
		$("mf_btn_delete").disabled = true;
		$("mf_btn_update").disabled = true;
		$("mf_btn_save").disabled = true;
	}

	function enableControlButtons() {
		disableControlButtons();
		
		if ($("<%=ModelFilter::HTML[:id]%>").value != "") {
			$("mf_btn_delete").disabled = false;
			$("mf_btn_update").disabled = false;
		}
		$("mf_btn_save").disabled = false;
	}
		
	function markDirty() {
		if ($("<%=ModelFilter::HTML[:key]%>") && $("<%=ModelFilter::HTML[:id]%>").value == "") {
			$("<%=ModelFilter::HTML[:key]%>").value = "-1";
		}

		disableControlButtons();
		$("mf_dirty").show();
	}
	
	function toggleFilter() {
		if ($("mf_container").style.display == "none") {
			$("mf_container").show();
			$("mf_toggler").innerHTML = "- Filter";
		} else {
			$("mf_container").hide();
			$("mf_toggler").innerHTML = "+ Filter";
		}
	}
		
	function saveFilter() {
		promptForFilterAction('save_filter');
	}
	
	function updateFilter() {
		promptForFilterAction('update_filter');
	}

	function deleteFilter() {
		promptForFilterAction('delete_filter');
	}

	function loadPredefinedFilter() {
		if ($("<%=ModelFilter::HTML[:key]%>").value == "-1" || $("<%=ModelFilter::HTML[:key]%>").value == "-2")
			return

		beginLoading();
		form_hash = $('mf_form').serialize(true);

		new Ajax.Updater('mf_filter', '/model_filter/load_filter', {
		  parameters: form_hash,
			onComplete: function(transport) {
				$('mf_form').submit();
			} 
		});
  }
	
	function performFilterAction(action) {
//		form_vals = $('filter_form').serialize();
//		alert(form_vals);
		
		if (action=="submit") {
			$('mf_form').submit();
			return;			
		}

		beginLoading();
		markDirty();
		
		form_hash = $('mf_form').serialize(true);
		form_hash["filter_action"] = action;
		
		new Ajax.Updater('mf_filter', '/model_filter/update', {
		  parameters: form_hash,
			evalScripts: true,
			onComplete: function(transport) {
				finishLoading();
			} 
		});
		
	}

//	function changeFilterModel() {
//		$("loader_icon").show();
//		form_hash = $('filter_form').serialize(true);
//		
//		$("filter_dirty").show();
//		
//		form_hash["model_changed"] = true
//		
//		new Ajax.Updater('filter', '/data_filter/change_filter_model', {
//		  parameters: form_hash,
//			onComplete: function(transport) {
//				$("loader_icon").hide();
//				disableControlButtons();
//				enableControlButtons();
//			} 
//		});
//		
//	}
	
	
    function promptForFilterAction(action) {
			if (action == "save_filter") {
		  	var filter_name = prompt("<%=@model_filter.label_for(:msg_prompt_name)%>", "");
				if (filter_name == null) return;
				$("<%=ModelFilter::HTML[:name]%>").value = filter_name;		
		  } else if (action == "update_filter") {
			  var filter_name = prompt("<%=@model_filter.label_for(:msg_prompt_name)%>", $("<%=ModelFilter::HTML[:name]%>").value) ;
				if (filter_name == null) return;
				$("<%=ModelFilter::HTML[:name]%>").value = filter_name;		
			} else {
				if (!confirm("<%=@model_filter.label_for(:msg_prompt_delete)%>")) return;
			}
		
			beginLoading();
			form_hash = $('mf_form').serialize(true);
			
			new Ajax.Updater('mf_filter', '/model_filter/' + action, {
			  parameters: form_hash,
				onComplete: function(transport) {
					if (action == "delete_filter") {
					  	$('mf_form').submit();
					} else {
					  	finishLoading();
					  	enableControlButtons();
					}								
				} 
			});
    }	
	
	//--> 
</script>

<%= render :partial => '/model_filter/filter_common' %>

<script>
    disableControlButtons();
    <% unless @model_filter.errors? %>
    		enableControlButtons();
    <% end %>
</script>
